<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>H-Focus Medical Laboratory | Check Patient's Result</title>

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="images/red.png" />

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick-theme.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" />
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

  <!-- Main Site Styles -->
  <link rel="stylesheet" href="styles/styles.css" />
</head>

<body class="body-loader">
  <!-- Page Loader -->
  <div class="page-loader">
    <div class="spinner-border text-danger" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <section class="wrapper">
    <!-- Header -->
    <header class="hero-anime">
      <div class="navigation-wrap start-header start-style">
        <div class="sub-nav border-bottom">
          <div class="container d-flex justify-content-between">
            <div class="d-flex justify-content-between">
              <a class="p-2 border-right border-left text-black" href="tel:0700 225 4365, 0700 CAL HFML"><i class="fas fa-phone-alt mr-2"></i> Phone: 0700 225 4365, 0700 CAL HFML</a>
              <a class="p-2 border-right text-black" href="mailto:support@hfocusmedical.com"><i class="fas fa-envelope mr-2"></i> Email: support@hfocusmedical.com</a>
            </div>
            <div class="d-flex justify-content-between">
              <a class="px-3 py-2 border-right border-left text-center text-black" target="_blank" href="https://web.facebook.com/hfocusmedical/"><i class="fab fa-facebook"></i></a>
              <a class="px-3 py-2 border-right text-black text-center" target="_blank" href="https://x.com/h_medicare"><i class="fab fa-twitter"></i></a>
              <a class="px-3 py-2 border-right text-black text-center" target="_blank" href="https://www.instagram.com/havefocusgroups/"><i class="fab fa-instagram"></i></a>
            </div>
          </div>
        </div>

        <nav class="navbar navbar-expand-md navbar-light">
          <div class="container">
            <a class="navbar-brand" href="index.html"><img src="logo.png" alt="Brand Logo" /></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav ml-auto py-4 py-md-0">
                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3"><a class="nav-link" href="about-us.html">About</a></li>
                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3"><a class="nav-link" href="services.html">Services</a></li>

                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3"><a class="nav-link" href="location.html">Location</a></li>
                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3"><a class="nav-link" href="contact.html">Contact</a></li>
                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3"><a class="nav-link" href="faqs.html">Faqs</a></li>
                <li class="nav-item px-2 px-md-0 mx-0 mx-md-3 active"><a class="nav-link" href="check-result.html">Check Result</a></li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="content-area py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%); min-height: 80vh;">
      <div class="container check-result-section">
        <!-- Hero Section -->
        <div class="text-center mb-5">
          <div class="hero-icon mb-4">
            <div class="d-inline-block p-4 rounded-circle" style="background: linear-gradient(135deg, #28a745, #20c997); box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);">
              <i class="fas fa-file-medical-alt text-white" style="font-size: 3rem;"></i>
            </div>
          </div>
          <h1 class="display-4 font-weight-bold mb-3" style="color: #2c5530; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            Check Your Test Results
          </h1>
          <p class="lead text-muted mb-4" style="max-width: 600px; margin: 0 auto;">
            Enter your unique ID or Organization ID below to securely access and download your medical test results
          </p>
        </div>

        <!-- Search Form Card -->
        <div class="row justify-content-center mb-5">
          <div class="col-lg-6 col-md-8">
            <div class="card border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
              <div class="card-header text-center py-4" style="background: linear-gradient(135deg, #28a745, #20c997); border: none;">
                <h4 class="text-white mb-0 font-weight-bold">
                  <i class="fas fa-search mr-2"></i>Patient Result Lookup
                </h4>
              </div>
              <div class="card-body p-5">
                <!-- Result Type Toggle -->
                <div class="text-center mb-4">
                  <div class="btn-group btn-group-toggle" data-toggle="buttons" role="group">
                    <label class="btn btn-outline-success active" id="individualLabel">
                      <input type="radio" name="resultType" id="individualType" value="individual" checked>
                      <i class="fas fa-user mr-2"></i>Individual Result
                    </label>
                    <label class="btn btn-outline-primary" id="corporateLabel">
                      <input type="radio" name="resultType" id="corporateType" value="corporate">
                      <i class="fas fa-building mr-2"></i>Corporate Results
                    </label>
                  </div>
                </div>

                <form id="resultForm">
                  <div class="form-group mb-4">
                    <label for="uniqueId" class="font-weight-bold text-dark mb-3" style="font-size: 1.1rem;" id="idLabel">
                      <i class="fas fa-id-card mr-2 text-success" id="idIcon"></i><span id="idText">Enter Your Unique ID</span>
                    </label>
                    <div class="input-group input-group-lg">
                      <div class="input-group-prepend">
                        <span class="input-group-text" style="background: #28a745; border-color: #28a745; color: white;" id="inputIcon">
                          <i class="fas fa-hashtag"></i>
                        </span>
                      </div>
                      <input type="text" id="uniqueId" class="form-control" 
                             placeholder="E.g. HFML123456" 
                             required 
                             style="border-color: #28a745; font-size: 1.1rem; padding: 12px;" />
                    </div>
                    <small class="form-text text-muted mt-2" id="helpText">
                      <i class="fas fa-info-circle mr-1"></i>
                      <span id="helpTextContent">Your unique ID was provided when you booked your appointment</span>
                    </small>
                  </div>
                  <button type="submit" class="btn btn-lg btn-block font-weight-bold" 
                          style="background: linear-gradient(135deg, #28a745, #20c997); 
                                 border: none; 
                                 border-radius: 50px; 
                                 padding: 15px; 
                                 font-size: 1.1rem;
                                 box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
                                 transition: all 0.3s ease;"
                          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(40, 167, 69, 0.4)'"
                          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(40, 167, 69, 0.3)'">
                    <i class="fas fa-search mr-2"></i>Check My Results
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Result Display -->
        <div id="resultStatus" class="d-none">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <div class="alert font-weight-bold text-center border-0 shadow-lg" 
                   role="alert" 
                   style="border-radius: 15px; font-size: 1.1rem; padding: 20px;"></div>
              <div id="resultDate" class="mt-4"></div>
              <div class="text-center mt-4">
                <a id="downloadBtn" href="#" class="btn btn-lg px-5 py-3 d-none font-weight-bold" 
                   download
                   style="background: linear-gradient(135deg, #28a745, #20c997); 
                          border: none; 
                          border-radius: 50px; 
                          color: white;
                          box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
                          transition: all 0.3s ease;"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(40, 167, 69, 0.4)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(40, 167, 69, 0.3)'">
                  <i class="fas fa-download mr-2"></i>Download Your Results
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="curve"></div>
      <div class="container">
        <!-- Paste your original footer HTML from the uploaded file here -->
      </div>
      <div class="sub-footer text-center bg-primary p-3">
        <span class="text-white">Copyright Â© 2025. H-Focus Medical Laboratory - All Rights Reserved.</span>
      </div>
    </footer>
  </section>

  <!-- Vendor Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="scripts/external/slick.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>

  <!-- Custom Scripts -->
  <script src="scripts/validation/jquery.validate.js"></script>
  <script src="scripts/common.js"></script>
  <script src="scripts/counter.js"></script>

  <!-- Page Script -->
  <script>
// Toggle functionality
$(document).ready(function() {
  const API_ROOT = location.origin + '/api';
  // Handle result type toggle
  $('input[name="resultType"]').change(function() {
    const resultType = $(this).val();
    updateFormForResultType(resultType);
  });
});

function updateFormForResultType(type) {
  const idText = $('#idText');
  const idIcon = $('#idIcon');
  const inputIcon = $('#inputIcon');
  const uniqueIdInput = $('#uniqueId');
  const helpTextContent = $('#helpTextContent');
  
  if (type === 'corporate') {
    idText.text('Enter Organization ID');
    idIcon.removeClass('fa-id-card text-success').addClass('fa-building text-primary');
    inputIcon.find('i').removeClass('fa-hashtag').addClass('fa-building');
    inputIcon.css({
      'background': '#007bff',
      'border-color': '#007bff'
    });
    uniqueIdInput.attr('placeholder', 'E.g. ORG001').css('border-color', '#007bff');
    helpTextContent.text('Your Organization ID was provided when your company registered for corporate services');
    
    // Update toggle button styles
    $('#individualLabel').removeClass('active btn-success').addClass('btn-outline-success');
    $('#corporateLabel').removeClass('btn-outline-primary').addClass('active btn-primary');
  } else {
    idText.text('Enter Your Unique ID');
    idIcon.removeClass('fa-building text-primary').addClass('fa-id-card text-success');
    inputIcon.find('i').removeClass('fa-building').addClass('fa-hashtag');
    inputIcon.css({
      'background': '#28a745',
      'border-color': '#28a745'
    });
    uniqueIdInput.attr('placeholder', 'E.g. HFML123456').css('border-color', '#28a745');
    helpTextContent.text('Your unique ID was provided when you booked your appointment');
    
    // Update toggle button styles
    $('#corporateLabel').removeClass('active btn-primary').addClass('btn-outline-primary');
    $('#individualLabel').removeClass('btn-outline-success').addClass('active btn-success');
  }
}

$("#resultForm").on("submit", function(e) {
  e.preventDefault();

  const id = $("#uniqueId").val().trim();
  const resultType = $('input[name="resultType"]:checked').val();
  const resultStatus = $("#resultStatus");
  const alertBox = resultStatus.find(".alert");
  const resultDate = $("#resultDate");
  const downloadBtn = $("#downloadBtn");

  // Clear previous results
  alertBox.removeClass().addClass("alert alert-info").text("Checking...");
  resultDate.text("");
  downloadBtn.addClass("d-none");
  resultStatus.removeClass("d-none");
  
  if (resultType === 'corporate') {
    checkCorporateResults(id, alertBox, resultDate, downloadBtn);
  } else {
    checkIndividualResults(id, alertBox, resultDate, downloadBtn);
  }
});

function checkIndividualResults(id, alertBox, resultDate, downloadBtn) {

  $.ajax({
    url: API_ROOT + "/appointments/" + id,
    method: "GET",
    success: function(resp) {
      if (resp.status === 1 && resp.data) {
        const appointment = resp.data;
        
        // Check if result is ready and file exists
        if (appointment.result_ready && appointment.result_file) {
          alertBox.removeClass().addClass("alert alert-success").html(
            '<i class="fas fa-check-circle"></i> <strong>Result is Ready!</strong><br>' +
            '<small>Your test results have been uploaded by the doctor and are ready for download.</small>'
          );
          
          resultDate.html(
            '<div class="card border-0 shadow-lg mt-4" style="border-radius: 20px; overflow: hidden;">' +
              '<div class="card-header text-center py-4" style="background: linear-gradient(135deg, #28a745, #20c997); border: none;">' +
                '<h4 class="text-white mb-0 font-weight-bold">' +
                  '<i class="fas fa-user-check mr-2"></i>Patient Information' +
                '</h4>' +
              '</div>' +
              '<div class="card-body p-4" style="background: linear-gradient(135deg, #f8f9fa, #e8f5e8);">' +
                '<div class="row">' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #28a745;"><i class="fas fa-user mr-2"></i>Patient:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.title + ' ' + appointment.first_name + ' ' + appointment.last_name + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #28a745;"><i class="fas fa-stethoscope mr-2"></i>Department:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.department + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #28a745;"><i class="fas fa-calendar mr-2"></i>Appointment Date:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.appointment_date + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #28a745;"><i class="fas fa-id-card mr-2"></i>Unique ID:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.unique_id + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #28a745;"><i class="fas fa-map-marker-alt mr-2"></i>Center:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.center_name + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #28a745;"><i class="fas fa-check-circle mr-2"></i>Status:</strong><br>' +
                      '<span class="badge badge-pill px-3 py-2" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-size: 0.9rem;">Ready for Download</span>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>'
          );
          
          // Set the actual result file path
          // Extract file extension from Cloudinary URL or default to original filename
          const fileUrl = appointment.result_file;
          
          // Extract file extension from URL
          let fileExtension = '.pdf'; // default
          try {
            const url = new URL(fileUrl);
            const pathname = url.pathname;
            const lastDot = pathname.lastIndexOf('.');
            if (lastDot > -1) {
              fileExtension = pathname.substring(lastDot);
            }
          } catch (e) {
            console.warn('Could not extract file extension, using default .pdf');
          }
          
          const fileName = "Result_" + appointment.unique_id + fileExtension;
          
          downloadBtn.removeClass("d-none")
                    .attr("href", fileUrl)
                    .attr("target", "_blank")
                    .html('<i class="fas fa-download"></i> Download Your Result');
          
          // Add click handler for direct download with error handling
          downloadBtn.off('click').on('click', function(e) {
            e.preventDefault();
            console.log('Downloading individual result:', { fileUrl, fileName, uniqueId: appointment.unique_id });
            
            if (!fileUrl || fileUrl === 'null' || fileUrl === 'undefined') {
              alert('No result file available for this appointment');
              return;
            }
            
            try {
              new URL(fileUrl);
              
              // Check if it's a Cloudinary PDF with image/upload path (restricted)
              if (fileUrl.includes('cloudinary.com') && fileUrl.includes('/image/upload/') && fileUrl.endsWith('.pdf')) {
                alert('PDF download is restricted on Cloudinary free accounts. Please contact the administrator to enable PDF delivery or upgrade the account.');
                console.warn('Cloudinary PDF delivery restriction detected:', fileUrl);
                return;
              }
              
              console.log('Opening individual result file:', fileUrl);
              
              const link = document.createElement('a');
              link.href = fileUrl;
              link.download = fileName;
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              console.log('Download initiated for individual appointment:', appointment.unique_id);
            } catch (error) {
              console.error('Invalid result file URL:', fileUrl);
              alert('Invalid result file URL. Please contact support.');
            }
          });
        } else {
          alertBox.removeClass().addClass("alert alert-warning").html(
            '<i class="fas fa-clock"></i> <strong>Result Not Ready Yet</strong><br>' +
            '<small>Your test results are still being processed. Please check back later or contact the lab.</small>'
          );
          
          resultDate.html(
            '<div class="card border-0 shadow-lg mt-4" style="border-radius: 20px; overflow: hidden;">' +
              '<div class="card-header text-center py-4" style="background: linear-gradient(135deg, #ffc107, #fd7e14); border: none;">' +
                '<h4 class="text-white mb-0 font-weight-bold">' +
                  '<i class="fas fa-clock mr-2"></i>Patient Information' +
                '</h4>' +
              '</div>' +
              '<div class="card-body p-4" style="background: linear-gradient(135deg, #fff8e1, #ffeaa7);">' +
                '<div class="row">' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #e67e22;"><i class="fas fa-user mr-2"></i>Patient:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.title + ' ' + appointment.first_name + ' ' + appointment.last_name + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #e67e22;"><i class="fas fa-stethoscope mr-2"></i>Department:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.department + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #e67e22;"><i class="fas fa-calendar mr-2"></i>Appointment Date:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.appointment_date + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #e67e22;"><i class="fas fa-id-card mr-2"></i>Unique ID:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.unique_id + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #e67e22;"><i class="fas fa-map-marker-alt mr-2"></i>Center:</strong><br>' +
                      '<span class="text-dark font-weight-medium">' + appointment.center_name + '</span>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-md-6 mb-3">' +
                    '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                      '<strong style="color: #e67e22;"><i class="fas fa-hourglass-half mr-2"></i>Status:</strong><br>' +
                      '<span class="badge badge-pill px-3 py-2" style="background: linear-gradient(135deg, #ffc107, #fd7e14); color: white; font-size: 0.9rem;">Processing</span>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>'
          );
          
          downloadBtn.addClass("d-none");
        }
      } else {
        alertBox.removeClass().addClass("alert alert-danger").html(
          '<i class="fas fa-exclamation-triangle"></i> <strong>No Record Found</strong><br>' +
          '<small>Please check your Unique ID and try again. If you continue to have issues, contact our support team.</small>'
        );
        resultDate.text("");
        downloadBtn.addClass("d-none");
      }
    },
    error: function(xhr) {
      if (xhr && xhr.status === 404) {
        alertBox.removeClass().addClass("alert alert-danger").html(
          '<i class="fas fa-exclamation-triangle"></i> <strong>No Record Found</strong><br>' +
          '<small>Please check your Unique ID and try again. If you continue to have issues, contact our support team.</small>'
        );
        resultDate.text("");
        downloadBtn.addClass("d-none");
      } else {
        alertBox.removeClass().addClass("alert alert-danger").html(
          '<i class="fas fa-exclamation-circle"></i> <strong>Server Error</strong><br>' +
          '<small>Unable to connect to the server. Please try again later or contact support.</small>'
        );
        resultDate.text("");
        downloadBtn.addClass("d-none");
      }
    }
  });
}

function checkCorporateResults(organizationId, alertBox, resultDate, downloadBtn) {
  // Use local API to fetch corporate booking data
  $.ajax({
    url: API_ROOT + "/corporate-bookings/" + organizationId,
    method: "GET",
    success: function(resp) {
      if (resp.status === 1 && resp.data) {
        const orgData = resp.data;
        
        alertBox.removeClass().addClass("alert alert-success").html(
          '<i class="fas fa-building"></i> <strong>Organization Found!</strong><br>' +
          '<small>Displaying all registered staff and their test results for ' + orgData.company_name + '</small>'
        );
        
        let employeeRows = '';
        let readyCount = 0;
        let totalCount = orgData.staff_members ? orgData.staff_members.length : 0;
        
        if (orgData.staff_members && orgData.staff_members.length > 0) {
          orgData.staff_members.forEach(function(employee) {
            if (employee.result_ready) readyCount++;
            
            employeeRows += `
              <tr>
                <td><strong>${employee.search_number || employee.searchNumber || employee.unique_id || `STAFF-${orgData.staff_members.indexOf(employee) + 1}`}</strong></td>
                <td>${employee.name}</td>
                <td>${employee.age || 'N/A'}</td>
                <td>${employee.gender || 'N/A'}</td>
                <td>${employee.department || orgData.department}</td>
                <td>${employee.appointment_date || 'Pending'}</td>
                <td>
                  ${employee.result_ready 
                    ? '<span class="badge badge-success">Ready</span>' 
                    : '<span class="badge badge-warning">Processing</span>'}
                </td>
                <td>
                  ${employee.result_ready && employee.result_file
                    ? `<button class="btn btn-sm btn-success" onclick="downloadResult('${employee.result_file}', '${employee.name}', '${employee.search_number || employee.searchNumber || employee.unique_id || `STAFF-${orgData.staff_members.indexOf(employee) + 1}`}')"><i class="fas fa-download mr-1"></i>Download Result</button>` 
                    : '<span class="text-warning font-weight-medium"><i class="fas fa-clock mr-1"></i>Check back Later, result not Ready</span>'}
                </td>
              </tr>
            `;
          });
        } else {
          employeeRows = '<tr><td colspan="8" class="text-center text-muted">No staff members registered yet</td></tr>';
        }
        
        resultDate.html(
          '<div class="card border-0 shadow-lg mt-4" style="border-radius: 20px; overflow: hidden;">' +
            '<div class="card-header text-center py-4" style="background: linear-gradient(135deg, #007bff, #0056b3); border: none;">' +
              '<h4 class="text-white mb-0 font-weight-bold">' +
                '<i class="fas fa-building mr-2"></i>Corporate Results - ' + orgData.company_name +
              '</h4>' +
            '</div>' +
            '<div class="card-body p-4" style="background: linear-gradient(135deg, #f8f9fa, #e3f2fd);">' +
              '<div class="row mb-4">' +
                '<div class="col-md-6">' +
                  '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                    '<strong style="color: #007bff;"><i class="fas fa-user-tie mr-2"></i>Contact Person:</strong><br>' +
                    '<span class="text-dark font-weight-medium">' + orgData.contact_person + '</span>' +
                  '</div>' +
                '</div>' +
                '<div class="col-md-6">' +
                  '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                    '<strong style="color: #007bff;"><i class="fas fa-chart-pie mr-2"></i>Results Status:</strong><br>' +
                    '<span class="text-dark font-weight-medium">' + readyCount + ' of ' + totalCount + ' Ready</span>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="table-responsive">' +
                '<table class="table table-hover">' +
                  '<thead class="thead-light">' +
                    '<tr>' +
                      '<th>Search Number</th>' +
                      '<th>Name</th>' +
                      '<th>Age</th>' +
                      '<th>Gender</th>' +
                      '<th>Department</th>' +
                      '<th>Test Date</th>' +
                      '<th>Status</th>' +
                      '<th>Action</th>' +
                    '</tr>' +
                  '</thead>' +
                  '<tbody>' +
                    employeeRows +
                  '</tbody>' +
                '</table>' +
              '</div>' +
            '</div>' +
          '</div>'
        );
        
        // Show bulk download button if any results are ready
        if (readyCount > 0) {
          downloadBtn.removeClass("d-none")
                    .html('<i class="fas fa-download mr-2"></i>Download All Ready Results (' + readyCount + ')')
                    .off('click').on('click', function(e) {
                      e.preventDefault();
                      alert('Bulk download feature will be implemented when the backend API is ready.');
                    });
        } else {
          downloadBtn.addClass("d-none");
        }
      } else {
        alertBox.removeClass().addClass("alert alert-danger").html(
          '<i class="fas fa-exclamation-triangle"></i> <strong>Organization Not Found</strong><br>' +
          '<small>Please check your Organization ID and try again. If you continue to have issues, contact our support team.</small>'
        );
        resultDate.text("");
        downloadBtn.addClass("d-none");
      }
    },
    error: function(xhr, status, error) {
      console.error('Error:', error);
      alertBox.removeClass().addClass("alert alert-danger").html(
        '<i class="fas fa-exclamation-circle"></i> <strong>Server Error</strong><br>' +
        '<small>Unable to connect to the server. Please try again later or contact support.</small>'
      );
      resultDate.text("");
      downloadBtn.addClass("d-none");
    }
  });
}

// Legacy mock data function - keeping for reference
function checkCorporateResultsMock(organizationId, alertBox, resultDate, downloadBtn) {
  // Mock corporate data for demonstration - replace with actual API when backend is ready
  const mockCorporateData = {
    "ORG001": {
      organization_id: "ORG001",
      company_name: "Tech Solutions Ltd",
      contact_person: "John Smith",
      email: "hr@techsolutions.com",
      phone: "+1-555-0123",
      status: "Active",
      employees: [
        {
          unique_id: "HFML789012",
          name: "Alice Johnson",
          department: "Medical Laboratory",
          appointment_date: "2025-01-20",
          result_ready: true,
          result_file: "https://example.com/results/alice_results.pdf"
        },
        {
          unique_id: "HFML789013",
          name: "Bob Wilson",
          department: "Health Check Plan/Consultation",
          appointment_date: "2025-01-21",
          result_ready: false,
          result_file: null
        },
        {
          unique_id: "HFML789014",
          name: "Carol Davis",
          department: "Ultrasound and Radiology",
          appointment_date: "2025-01-22",
          result_ready: true,
          result_file: "https://example.com/results/carol_results.pdf"
        }
      ]
    },
    "ORG002": {
      organization_id: "ORG002",
      company_name: "Global Industries",
      contact_person: "Sarah Johnson",
      email: "admin@globalind.com",
      phone: "+1-555-0456",
      status: "Active",
      employees: [
        {
          unique_id: "HFML789015",
          name: "David Brown",
          department: "Medical Laboratory",
          appointment_date: "2025-01-19",
          result_ready: true,
          result_file: "https://example.com/results/david_results.pdf"
        }
      ]
    }
  };

  // Simulate API delay
  setTimeout(function() {
    const orgData = mockCorporateData[organizationId];
    
    if (orgData) {
      alertBox.removeClass().addClass("alert alert-success").html(
        '<i class="fas fa-building"></i> <strong>Organization Found!</strong><br>' +
        '<small>Displaying all registered staff and their test results for ' + orgData.company_name + '</small>'
      );
      
      let employeeRows = '';
      let readyCount = 0;
      let totalCount = orgData.employees.length;
      
      orgData.employees.forEach(function(employee) {
        if (employee.result_ready) readyCount++;
        
        employeeRows += `
          <tr>
            <td><strong>${employee.unique_id}</strong></td>
            <td>${employee.name}</td>
            <td>${employee.department}</td>
            <td>${employee.appointment_date}</td>
            <td>
              ${employee.result_ready 
                ? '<span class="badge badge-success">Ready</span>' 
                : '<span class="badge badge-warning">Processing</span>'}
            </td>
            <td>
              ${employee.result_ready 
                ? `<a href="${employee.result_file}" target="_blank" class="btn btn-sm btn-success"><i class="fas fa-download mr-1"></i>Download</a>` 
                : '<span class="text-muted">Not Available</span>'}
            </td>
          </tr>
        `;
      });
      
      resultDate.html(
        '<div class="card border-0 shadow-lg mt-4" style="border-radius: 20px; overflow: hidden;">' +
          '<div class="card-header text-center py-4" style="background: linear-gradient(135deg, #007bff, #0056b3); border: none;">' +
            '<h4 class="text-white mb-0 font-weight-bold">' +
              '<i class="fas fa-building mr-2"></i>Corporate Results - ' + orgData.company_name +
            '</h4>' +
          '</div>' +
          '<div class="card-body p-4" style="background: linear-gradient(135deg, #f8f9fa, #e3f2fd);">' +
            '<div class="row mb-4">' +
              '<div class="col-md-6">' +
                '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                  '<strong style="color: #007bff;"><i class="fas fa-user-tie mr-2"></i>Contact Person:</strong><br>' +
                  '<span class="text-dark font-weight-medium">' + orgData.contact_person + '</span>' +
                '</div>' +
              '</div>' +
              '<div class="col-md-6">' +
                '<div class="info-item p-3 rounded" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' +
                  '<strong style="color: #007bff;"><i class="fas fa-chart-pie mr-2"></i>Results Status:</strong><br>' +
                  '<span class="text-dark font-weight-medium">' + readyCount + ' of ' + totalCount + ' Ready</span>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="table-responsive">' +
              '<table class="table table-hover">' +
                '<thead class="thead-light">' +
                  '<tr>' +
                    '<th>Search Number</th>' +
                    '<th>Name</th>' +
                    '<th>Department</th>' +
                    '<th>Test Date</th>' +
                    '<th>Status</th>' +
                    '<th>Action</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody>' +
                  employeeRows +
                '</tbody>' +
              '</table>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
      
      // Show bulk download button if any results are ready
      if (readyCount > 0) {
        downloadBtn.removeClass("d-none")
                  .html('<i class="fas fa-download mr-2"></i>Download All Ready Results (' + readyCount + ')')
                  .off('click').on('click', function(e) {
                    e.preventDefault();
                    alert('Bulk download feature will be implemented when the backend API is ready.');
                  });
      } else {
        downloadBtn.addClass("d-none");
      }
    } else {
      alertBox.removeClass().addClass("alert alert-danger").html(
        '<i class="fas fa-exclamation-triangle"></i> <strong>Organization Not Found</strong><br>' +
        '<small>Please check your Organization ID and try again. If you continue to have issues, contact our support team.</small>'
      );
      resultDate.text("");
      downloadBtn.addClass("d-none");
    }
  }, 1000);
}

// Download result function with error handling
function downloadResult(resultFile, employeeName, searchNumber) {
  console.log('Downloading result:', { resultFile, employeeName, searchNumber });
  
  if (!resultFile || resultFile === 'null' || resultFile === 'undefined') {
    alert('No result file available for ' + employeeName);
    return;
  }
  
  // Check if it's a valid URL
  try {
    new URL(resultFile);
    
    // Check if it's a Cloudinary PDF with image/upload path (restricted)
    if (resultFile.includes('cloudinary.com') && resultFile.includes('/image/upload/') && resultFile.endsWith('.pdf')) {
      alert('PDF download is restricted on Cloudinary free accounts. Please contact the administrator to enable PDF delivery or upgrade the account.');
      console.warn('Cloudinary PDF delivery restriction detected for', employeeName + ':', resultFile);
      return;
    }
    
    console.log('Opening result file for', employeeName + ':', resultFile);
    
    // Extract file extension from URL
    let fileExtension = '.pdf'; // default
    try {
      const url = new URL(resultFile);
      const pathname = url.pathname;
      const lastDot = pathname.lastIndexOf('.');
      if (lastDot > -1) {
        fileExtension = pathname.substring(lastDot);
      }
    } catch (e) {
      console.warn('Could not extract file extension, using default .pdf');
    }
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = resultFile;
    link.target = '_blank';
    link.download = `${employeeName}_${searchNumber}_result${fileExtension}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Download initiated for', employeeName);
  } catch (error) {
    console.error('Invalid result file URL for', employeeName + ':', resultFile);
    alert('Invalid result file URL for ' + employeeName + '. Please contact support.');
  }
}


  </script>
</body>
</html>
