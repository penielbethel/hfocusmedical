<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H-Focus Medical Lab | Admin Panel</title>
  <link rel="shortcut icon" type="image/x-icon" href="images/red.png" />

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body {
      background: #f4f6f9;
      font-family: 'Poppins', sans-serif;
    }
    .navbar {
      background: #007bff;
    }
    .navbar-brand, .navbar-nav .nav-link {
      color: #fff !important;
      font-weight: 600;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    table th {
      background: #007bff;
      color: #fff;
    }
    .badge-ready {
      background: #28a745;
      color: #fff;
    }
    .badge-pending {
      background: #ffc107;
      color: #000;
    }
    .upload-btn {
      font-size: 13px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="#">HFML Admin Panel</a>
    <button class="btn btn-light ml-auto" onclick="logout()">Logout</button>
  </nav>

  <!-- Container -->
  <div class="container py-5">
    <h2 class="mb-4">Appointments Management</h2>

    <!-- Search Bar -->
    <div class="input-group mb-4">
      <input type="text" id="searchBox" class="form-control" placeholder="Search by Unique ID, Name, or Date">
      <div class="input-group-append">
        <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <!-- Appointment Table -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="appointmentsTable">
            <thead>
              <tr>
                <th>Unique ID</th>
                <th>Patient</th>
                <th>Department</th>
                <th>Date</th>
                <th>Slot</th>
                <th>Center</th>
                <th>Status</th>
                <th>Result</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="appointmentsBody">
              <!-- Dynamic Rows -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="uploadForm">
          <div class="modal-header">
            <h5 class="modal-title">Upload Patient Result</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="uploadUniqueId">
            <div class="form-group">
              <label>Upload PDF Result</label>
              <input type="file" id="resultFile" accept="application/pdf" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Upload</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "https://hfocusmedical.onrender.com/api/appointments";
    let token = localStorage.getItem("token");

    // Redirect to login if no token
    if (!token) {
      alert("Please login first.");
      window.location.href = "adminLogin.html"; 
    }

    // Add Authorization header to all fetches
    async function apiFetch(url, options = {}) {
      options.headers = options.headers || {};
      options.headers["Authorization"] = "Bearer " + token;
      return fetch(url, options);
    }

    // Load appointments
    async function loadAppointments(query = "") {
      const res = await apiFetch(API_BASE);
      const data = await res.json();
      if (data.status === 1) {
        let rows = "";
        data.data.forEach(app => {
          if (query && !(
              app.unique_id.toLowerCase().includes(query) ||
              (app.first_name + " " + app.last_name).toLowerCase().includes(query) ||
              app.appointment_date.includes(query)
          )) return;

          rows += `
            <tr>
              <td><b>${app.unique_id}</b></td>
              <td>${app.title} ${app.first_name} ${app.last_name}</td>
              <td>${app.department}</td>
              <td>${app.appointment_date}</td>
              <td>${app.appointment_time || "-"}</td>
              <td>${app.center_name}</td>
              <td>
                ${app.result_ready 
                  ? '<span class="badge badge-ready">Ready</span>' 
                  : '<span class="badge badge-pending">Pending</span>'}
              </td>
              <td>
                ${app.result_ready 
                  ? `<a href="${app.result_file}" target="_blank" class="btn btn-sm btn-success">View</a>` 
                  : `<button class="btn btn-sm btn-primary upload-btn" onclick="openUpload('${app.unique_id}')">Upload</button>`}
              </td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteAppointment('${app.unique_id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        });
        $("#appointmentsBody").html(rows || "<tr><td colspan='9' class='text-center'>No records found</td></tr>");
      }
    }

    // Open upload modal
    function openUpload(uniqueId) {
      $("#uploadUniqueId").val(uniqueId);
      $("#uploadModal").modal("show");
    }

    // Handle upload form
    $("#uploadForm").on("submit", async function(e) {
      e.preventDefault();
      const uniqueId = $("#uploadUniqueId").val();
      const file = $("#resultFile")[0].files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("result", file);

      const res = await apiFetch(`${API_BASE}/upload/${uniqueId}`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.status === 1) {
        alert("Result uploaded successfully");
        $("#uploadModal").modal("hide");
        loadAppointments();
      } else {
        alert("Upload failed");
      }
    });

    // Delete appointment
    async function deleteAppointment(uniqueId) {
      if (!confirm("Are you sure you want to delete this record?")) return;
      const res = await apiFetch(`${API_BASE}/${uniqueId}`, { method: "DELETE" });
      const data = await res.json();
      if (data.status === 1) {
        alert("Deleted successfully");
        loadAppointments();
      }
    }

    // Logout
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "adminLogin.html"; 
    }

    // Search
    $("#searchBtn").click(() => loadAppointments($("#searchBox").val().toLowerCase()));
    $("#searchBox").on("keyup", function(e) {
      if (e.key === "Enter") loadAppointments(this.value.toLowerCase());
    });

    // Init
    loadAppointments();
  </script>
</body>
</html>
