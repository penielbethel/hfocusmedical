<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H-Focus Medical Lab | Admin Panel</title>
  <link rel="shortcut icon" type="image/x-icon" href="images/red.png" />

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    body {
      background: #f4f6f9;
      font-family: 'Poppins', sans-serif;
    }
    .navbar {
      background: #007bff;
    }
    .navbar-brand, .navbar-nav .nav-link {
      color: #fff !important;
      font-weight: 600;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    table th {
      background: #007bff;
      color: #fff;
    }
    .badge-ready {
      background: #28a745;
      color: #fff;
    }
    .badge-pending {
      background: #ffc107;
      color: #000;
    }
    .upload-btn {
      font-size: 13px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="#">HFML Admin Panel</a>
    <button class="btn btn-light ml-auto" onclick="logout()">Logout</button>
  </nav>

  <!-- Container -->
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary"><i class="fas fa-tachometer-alt mr-2"></i>Appointments Management System</h2>
      <div>
        <button class="btn btn-warning mr-2" onclick="recalculateCosts()" title="Fix undefined costs in existing bookings">
          <i class="fas fa-calculator mr-1"></i>Fix Costs
        </button>
        <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="bookingTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="individual-tab" data-toggle="tab" href="#individual" role="tab" aria-controls="individual" aria-selected="true">
          <i class="fas fa-user"></i> Individual Bookings
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="corporate-tab" data-toggle="tab" href="#corporate" role="tab" aria-controls="corporate" aria-selected="false">
          <i class="fas fa-building"></i> Corporate Bookings
        </a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="bookingTabsContent">
      
      <!-- Individual Bookings Tab -->
      <div class="tab-pane fade show active" id="individual" role="tabpanel" aria-labelledby="individual-tab">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="text-primary"><i class="fas fa-user-md"></i> Individual Patient Appointments</h4>
          <span class="badge badge-info" id="individualCount">0 Records</span>
        </div>
        
        <!-- Search Bar for Individual -->
        <div class="input-group mb-4">
          <input type="text" id="searchBoxIndividual" class="form-control" placeholder="Search by Unique ID, Patient Name, or Date">
          <div class="input-group-append">
            <button class="btn btn-primary" id="searchBtnIndividual"><i class="fas fa-search"></i></button>
          </div>
        </div>

        <!-- Individual Appointments Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="individualAppointmentsTable">
                <thead>
                  <tr>
                    <th>Unique ID</th>
                    <th>Patient</th>
                    <th>Department</th>
                    <th>Date</th>
                    <th>Slot</th>
                    <th>Center</th>
                    <th>Status</th>
                    <th>Result</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="individualAppointmentsBody">
                  <!-- Dynamic Rows -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Corporate Bookings Tab -->
      <div class="tab-pane fade" id="corporate" role="tabpanel" aria-labelledby="corporate-tab">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="text-success"><i class="fas fa-building"></i> Corporate Organization Bookings</h4>
          <span class="badge badge-success" id="corporateCount">0 Organizations</span>
        </div>
        
        <!-- Search Bar for Corporate -->
        <div class="input-group mb-4">
          <input type="text" id="searchBoxCorporate" class="form-control" placeholder="Search by Organization ID, Company Name, or Contact Person">
          <div class="input-group-append">
            <button class="btn btn-success" id="searchBtnCorporate"><i class="fas fa-search"></i></button>
          </div>
        </div>

        <!-- Corporate Bookings Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="corporateBookingsTable">
                <thead>
                  <tr>
                    <th>Organization ID</th>
                    <th>Company/Hospital</th>
                    <th>Contact Person</th>
                    <th>Department/Service</th>
                    <th>Employees</th>
                    <th>Total Cost</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="corporateBookingsBody">
                  <!-- Dynamic Rows -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="uploadForm">
          <div class="modal-header">
            <h5 class="modal-title">Upload Patient Result</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="uploadUniqueId">
            <div class="form-group">
              <label>Upload PDF Result</label>
              <input type="file" id="resultFile" accept="application/pdf" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Upload</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_ROOT = location.origin + "/api";
    const API_BASE = API_ROOT + "/appointments";
    let token = localStorage.getItem("token");

    // Redirect to login if no token
    if (!token) {
      alert("Please login first.");
      window.location.href = "adminLogin.html"; 
    }
    
    // Clear token if it's invalid (for debugging)
    if (token && token.includes('hfocusmedical.onrender.com')) {
      localStorage.removeItem('token');
      alert('Please login again with local server.');
      window.location.href = 'adminLogin.html';
    }

    // Add Authorization header to all fetches
    async function apiFetch(url, options = {}) {
      options.headers = options.headers || {};
      options.headers["Authorization"] = "Bearer " + token;
      return fetch(url, options);
    }

    // Load individual appointments
    async function loadIndividualAppointments(query = "") {
      const res = await apiFetch(API_BASE);
      const data = await res.json();
      if (data.status === 1) {
        let rows = "";
        let count = 0;
        data.data.forEach(app => {
          if (query && !(
              app.unique_id.toLowerCase().includes(query) ||
              (app.first_name + " " + app.last_name).toLowerCase().includes(query) ||
              app.appointment_date.includes(query)
          )) return;

          count++;
          rows += `
            <tr>
              <td><b>${app.unique_id}</b></td>
              <td>${app.title} ${app.first_name} ${app.last_name}</td>
              <td>${app.department}</td>
              <td>${app.appointment_date}</td>
              <td>${app.appointment_time || "-"}</td>
              <td>${app.center_name}</td>
              <td>
                ${app.result_ready 
                  ? '<span class="badge badge-ready">Ready</span>' 
                  : '<span class="badge badge-pending">Pending</span>'}
              </td>
              <td>
                ${app.result_ready 
                  ? `<button class="btn btn-sm btn-success mr-1" onclick="viewIndividualResult('${app.unique_id}', '${app.result_file}')">View Result</button><button class="btn btn-sm btn-warning upload-btn" onclick="openUpload('${app.unique_id}')">Re-upload</button>` 
                  : `<button class="btn btn-sm btn-primary upload-btn" onclick="openUpload('${app.unique_id}')">Upload</button>`}
              </td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteIndividualAppointment('${app.unique_id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        });
        $("#individualAppointmentsBody").html(rows || "<tr><td colspan='9' class='text-center'>No records found</td></tr>");
        $("#individualCount").text(`${count} Records`);
      }
    }

    // Load corporate bookings from API
    async function loadCorporateBookings(query = "") {
      try {
        // Show loading state
        $("#corporateBookingsBody").html("<tr><td colspan='10' class='text-center'><i class='fas fa-spinner fa-spin'></i> Loading...</td></tr>");
        
        // Fetch data from API
        const response = await fetch(API_ROOT + '/corporate-bookings', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch corporate bookings');
        }
        
        const result = await response.json();
        const corporateData = result.data || [];

        let rows = "";
        let count = 0;
        corporateData.forEach(org => {
          if (query && !(
              org.organization_id.toLowerCase().includes(query) ||
              org.company_name.toLowerCase().includes(query) ||
              org.contact_person.toLowerCase().includes(query)
          )) return;

          count++;
          const statusBadge = org.status === 'confirmed' ? 'badge-success' : 
                             org.status === 'pending' ? 'badge-warning' : 'badge-secondary';
          const statusText = org.status.charAt(0).toUpperCase() + org.status.slice(1);
          
          rows += `
            <tr>
              <td><b>${org.organization_id}</b></td>
              <td>${org.company_name}</td>
              <td>${org.contact_person}</td>
              <td>${org.department}</td>
              <td>
                <span class="badge badge-info">${org.staff_count || 0} Staff</span>
                ${org.number_of_employees ? `<br><small class="text-muted">${org.number_of_employees} Total Employees</small>` : ''}
              </td>
              <td>
                <span class="badge badge-success" style="font-size: 0.9em;">
                  NGN ${(org.total_investigation_cost || 0).toLocaleString()}
                </span>
              </td>
              <td>${org.company_email}</td>
              <td>${org.contact_phone}</td>
              <td>
                <span class="badge ${statusBadge}">
                  ${statusText}
                </span>
              </td>
              <td>
                <button class="btn btn-info btn-sm mr-1" onclick="viewCorporateDetails('${org.organization_id}')" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-primary btn-sm mr-1" onclick="manageCorporateStaff('${org.organization_id}')" title="Manage Staff">
                  <i class="fas fa-users"></i>
                </button>
                <button class="btn btn-success btn-sm mr-1" onclick="updateCorporateStatus('${org.organization_id}', 'confirmed')" title="Confirm Booking">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteCorporateBooking('${org.organization_id}')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        $("#corporateBookingsBody").html(rows || "<tr><td colspan='10' class='text-center'>No organizations found</td></tr>");
        $("#corporateCount").text(`${count} Organizations`);
      } catch (error) {
        console.error('Error loading corporate bookings:', error);
        $("#corporateBookingsBody").html("<tr><td colspan='10' class='text-center text-danger'><i class='fas fa-exclamation-triangle'></i> Error loading data</td></tr>");
        $("#corporateCount").text('0 Organizations');
      }
    }

    // Open upload modal
    function openUpload(uniqueId) {
      $("#uploadUniqueId").val(uniqueId);
      $("#uploadModal").modal("show");
    }

    // Handle upload form
    $("#uploadForm").on("submit", async function(e) {
      e.preventDefault();
      const uniqueId = $("#uploadUniqueId").val();
      const file = $("#resultFile")[0].files[0];
      
      if (!file) {
        alert("Please select a file to upload");
        return;
      }
      
      if (!uniqueId) {
        alert("Invalid unique ID");
        return;
      }
      
      console.log(`Uploading file: ${file.name} for uniqueId: ${uniqueId}`);
      
      // Show loading state
      const submitBtn = $(this).find('button[type="submit"]');
      const originalText = submitBtn.text();
      submitBtn.text('Uploading...').prop('disabled', true);

      try {
        const formData = new FormData();
        formData.append("result", file);

        const res = await apiFetch(`${API_BASE}/upload/${uniqueId}`, {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        
        if (data.status === 1) {
          alert("Result uploaded successfully!");
          $("#uploadModal").modal("hide");
          loadIndividualAppointments();
        } else {
          console.error('Upload failed:', data);
          alert(`Upload failed: ${data.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert(`Upload error: ${error.message}`);
      } finally {
        // Reset button state
        submitBtn.text(originalText).prop('disabled', false);
      }
    });

    // Delete individual appointment
    async function deleteIndividualAppointment(uniqueId) {
      if (!confirm("Are you sure you want to delete this appointment?")) return;
      
      const res = await apiFetch(`${API_BASE}/${uniqueId}`, {
        method: "DELETE"
      });
      
      const data = await res.json();
      if (data.status === 1) {
        alert("Appointment deleted successfully!");
        loadIndividualAppointments();
      } else {
        alert("Delete failed: " + data.message);
      }
    }

    // Corporate booking functions
    function viewCorporateDetails(organizationId) {
      alert(`Viewing details for Organization ID: ${organizationId}`);
      // TODO: Implement detailed view modal
    }

    function manageCorporateStaff(organizationId) {
      alert(`Managing staff for Organization ID: ${organizationId}`);
      // TODO: Implement staff management interface
    }

    function deleteCorporateBooking(organizationId) {
      if (!confirm(`Are you sure you want to delete the corporate booking for Organization ID: ${organizationId}?`)) return;
      
      alert(`Corporate booking ${organizationId} deleted successfully!`);
      loadCorporateBookings();
      // TODO: Implement actual API call when backend is ready
    }

    // Recalculate costs function
    async function recalculateCosts() {
      if (!confirm('This will recalculate costs for all corporate bookings. Continue?')) {
        return;
      }
      
      try {
        const response = await fetch(API_ROOT + '/corporate-bookings/recalculate-costs', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        if (result.status === 1) {
          alert(`Success! Updated ${result.updated_count} corporate bookings.`);
          loadCorporateBookings(); // Refresh the data
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        alert('Error recalculating costs: ' + error.message);
      }
    }

    // Logout
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "adminLogin.html";
    }

    // Search functions
    function searchIndividualAppointments() {
      const query = $("#searchBoxIndividual").val().toLowerCase();
      loadIndividualAppointments(query);
    }

    function searchCorporateBookings() {
      const query = $("#searchBoxCorporate").val().toLowerCase();
      loadCorporateBookings(query);
    }

    // Search event handlers
    $("#searchBtnIndividual").click(() => searchIndividualAppointments());
    $("#searchBoxIndividual").on("keyup", function(e) {
      if (e.key === "Enter") searchIndividualAppointments();
    });

    $("#searchBtnCorporate").click(() => searchCorporateBookings());
    $("#searchBoxCorporate").on("keyup", function(e) {
      if (e.key === "Enter") searchCorporateBookings();
    });

    // Corporate management functions
    async function updateCorporateStatus(organizationId, status) {
      try {
        const response = await fetch(`${API_ROOT}/corporate-bookings/${organizationId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          alert(`Organization status updated to ${status}`);
          loadCorporateBookings();
        } else {
          throw new Error('Failed to update status');
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating organization status');
      }
    }
    
    async function deleteCorporateBooking(organizationId) {
      if (!confirm('Are you sure you want to delete this corporate booking?')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_ROOT}/corporate-bookings/${organizationId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (response.ok) {
          alert('Corporate booking deleted successfully');
          loadCorporateBookings();
        } else {
          throw new Error('Failed to delete booking');
        }
      } catch (error) {
        console.error('Error deleting booking:', error);
        alert('Error deleting corporate booking');
      }
    }
    
    async function viewCorporateDetails(organizationId) {
      try {
        const response = await fetch(`${API_ROOT}/corporate-bookings/${organizationId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          const org = result.data;
          
          const details = `
            Organization ID: ${org.organization_id}
            Company: ${org.company_name}
            Contact Person: ${org.contact_person}
            Email: ${org.company_email}
            Phone: ${org.contact_phone}
            Service: ${org.department}
            Employees: ${org.number_of_employees || 'N/A'}
            Status: ${org.status}
            Message: ${org.additional_info}
            ${org.investigations && org.investigations.length > 0 ? `
            Investigations: ${org.investigations.length} test(s) selected:
            ${Array.isArray(org.investigations) ? org.investigations.map((inv, index) => {
              if (typeof inv === 'object' && inv.price) {
                return `- Investigation ${index + 1} - NGN ${inv.price?.toLocaleString() || '0'}`;
              }
              return `- ${inv.test_name || inv.name || inv.category || inv.test || inv.testName || inv || 'Unknown Test'}`;
            }).join('\n            ') : `- ${org.investigations}`}
            Total Cost: NGN ${org.total_investigation_cost?.toLocaleString() || '0'}` : ''}
            Created: ${new Date(org.created_at).toLocaleString()}
          `;
          
          alert(details);
        } else {
          throw new Error('Failed to fetch details');
        }
      } catch (error) {
        console.error('Error fetching details:', error);
        alert('Error loading organization details');
      }
    }
    
    async function manageCorporateStaff(organizationId) {
      try {
        const response = await fetch(`${API_ROOT}/corporate-bookings/${organizationId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          const org = result.data;
          
          if (org.staff_members && org.staff_members.length > 0) {
            // Create modal for staff management
            let staffRows = '';
            org.staff_members.forEach((staff, index) => {
              // Ensure staff object has all required properties with fallbacks
              const staffData = {
                search_number: staff.search_number || staff.searchNumber || staff.unique_id || `STAFF-${index + 1}`,
                name: staff.name || staff.full_name || 'Unknown',
                age: staff.age || staff.staff_age || 'Not specified',
                gender: staff.gender || staff.staff_gender || 'Not specified',
                investigations: staff.investigations || staff.selected_investigations || [],
                individual_cost: staff.individual_cost || staff.individualCost || staff.cost || 0,
                result_ready: staff.result_ready || false,
                result_file: staff.result_file || null
              };
              
              const resultStatus = staffData.result_ready ? 
                '<span class="badge badge-success">Ready</span>' : 
                '<span class="badge badge-warning">Pending</span>';
              
              const resultActions = staffData.result_ready && staffData.result_file ?
                `<button class="btn btn-sm btn-success mr-1" onclick="viewResult('${org.organization_id}', ${index})" title="View Result">
                   <i class="fas fa-eye"></i> View
                 </button>
                 <button class="btn btn-sm btn-warning" onclick="uploadResult('${org.organization_id}', ${index}, '${staffData.name}')" title="Re-upload Result">
                   <i class="fas fa-upload"></i> Re-upload
                 </button>` :
                `<button class="btn btn-sm btn-primary" onclick="uploadResult('${org.organization_id}', ${index}, '${staffData.name}')" title="Upload Result">
                   <i class="fas fa-upload"></i> Upload
                 </button>`;
              
              const investigationsList = staffData.investigations && staffData.investigations.length > 0 ? 
                `${staffData.investigations.length} test(s):<br><small>- ${staffData.investigations.map((inv, index) => {
                  if (typeof inv === 'string') return inv;
                  if (typeof inv === 'object') {
                    // First try to get the actual test name from the object
                    return inv.test_name || inv.name || inv.category || inv.test || inv.testName || `Test ${index + 1}`;
                  }
                  return `Test ${index + 1}`;
                }).join('<br>- ')}</small>` : 'No tests assigned';
              
              staffRows += `
                <tr>
                  <td><strong>${staffData.search_number || staffData.searchNumber || staffData.unique_id || `STAFF-${org.staff_members.indexOf(staffData) + 1}`}</strong></td>
                  <td>${staffData.name}</td>
                  <td>${staffData.age}</td>
                  <td>${staffData.gender}</td>
                  <td>${investigationsList}</td>
                  <td>${resultStatus}</td>
                  <td>${resultActions}</td>
                </tr>
              `;
            });
            
            const modalContent = `
              <div class="modal fade" id="staffModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title"><i class="fas fa-users mr-2"></i>Staff Members - ${org.company_name}</h5>
                      <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <!-- Tab Navigation -->
                      <ul class="nav nav-tabs" id="staffTabs" role="tablist">
                        <li class="nav-item">
                          <a class="nav-link active" id="staff-tab" data-toggle="tab" href="#staff" role="tab">
                            <i class="fas fa-users mr-1"></i>Staff Members
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" id="cost-tab" data-toggle="tab" href="#cost" role="tab">
                            <i class="fas fa-calculator mr-1"></i>Cost Breakdown
                          </a>
                        </li>
                      </ul>
                      
                      <!-- Tab Content -->
                      <div class="tab-content" id="staffTabContent">
                        <!-- Staff Members Tab -->
                        <div class="tab-pane fade show active" id="staff" role="tabpanel">
                          <div class="table-responsive mt-3">
                            <table class="table table-hover">
                              <thead class="thead-light">
                                <tr>
                                  <th>Search Number</th>
                                  <th>Name</th>
                                  <th>Age</th>
                                  <th>Gender</th>
                                  <th>Investigations</th>
                                  <th>Result Status</th>
                                  <th>Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                ${staffRows}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        
                        <!-- Cost Breakdown Tab -->
                        <div class="tab-pane fade" id="cost" role="tabpanel">
                          <div class="mt-3">
                            <div class="row">
                              <div class="col-md-8">
                                <h6><i class="fas fa-list-alt mr-2"></i>Individual Staff Costs</h6>
                                <div class="table-responsive">
                                  <table class="table table-sm table-striped">
                                    <thead class="thead-light">
                                      <tr>
                                        <th>Staff Member</th>
                                        <th>Investigations</th>
                                        <th>Individual Cost</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      ${org.staff_members.map(staff => {
                                        const staffData = {
                                          name: staff.name || staff.full_name || 'Unknown',
                                          investigations: staff.investigations || [],
                                          individual_cost: staff.individual_cost || 0
                                        };
                                        
                                        const costBreakdown = staffData.investigations.map(inv => {
                                          if (typeof inv === 'object') {
                                            const testName = inv.test_name || inv.name || inv.category || inv.test || inv.testName || 'Unknown Test';
                                            const price = inv.price || 0;
                                            return `${testName} - NGN ${price.toLocaleString()}`;
                                          }
                                          return typeof inv === 'string' ? inv : 'Unknown Test';
                                        }).join('<br>');
                                        
                                        return `
                                          <tr>
                                            <td><strong>${staffData.name}</strong></td>
                                            <td><small>${costBreakdown || 'No tests assigned'}</small></td>
                                            <td><strong>NGN ${staffData.individual_cost.toLocaleString()}</strong></td>
                                          </tr>
                                        `;
                                      }).join('')}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                              <div class="col-md-4">
                                <div class="card bg-light">
                                  <div class="card-body">
                                    <h6><i class="fas fa-calculator mr-2"></i>Summary</h6>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                      <span>Total Staff:</span>
                                      <strong>${org.staff_members.length}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                      <span>Total Investigations:</span>
                                      <strong>${org.staff_members.reduce((total, staff) => total + (staff.investigations ? staff.investigations.length : 0), 0)}</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                      <span><strong>Total Cost:</strong></span>
                                      <strong class="text-success">NGN ${(org.total_investigation_cost || 0).toLocaleString()}</strong>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Remove existing modal if any
            $('#staffModal').remove();
            // Add new modal to body
            $('body').append(modalContent);
            // Show modal
            $('#staffModal').modal('show');
          } else {
            alert(`No staff members registered for ${org.company_name} yet.`);
          }
        } else {
          throw new Error('Failed to fetch staff details');
        }
      } catch (error) {
        console.error('Error fetching staff details:', error);
        alert('Error loading staff details');
      }
    }

    // Add result upload functionality
    async function uploadResult(organizationId, staffIndex, staffName) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
      input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('result_file', file);
        
        try {
          const response = await fetch(`${API_ROOT}/corporate-bookings/${organizationId}/staff/${staffIndex}/result`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
          });
          
          if (response.ok) {
            alert(`Result uploaded successfully for ${staffName}`);
            // Refresh the modal or reload data
            location.reload();
          } else {
            throw new Error('Failed to upload result');
          }
        } catch (error) {
          console.error('Error uploading result:', error);
          alert('Error uploading result file');
        }
      };
      input.click();
    }

    // View uploaded result
    // View individual appointment result
    function viewIndividualResult(uniqueId, resultFile) {
      console.log('Viewing individual result:', { uniqueId, resultFile });
      
      if (!resultFile || resultFile === 'null' || resultFile === 'undefined') {
        alert('No result file available for this appointment');
        return;
      }
      
      // Check if it's a valid URL
      try {
        new URL(resultFile);
        
        // Check if it's a Cloudinary PDF with image/upload path (restricted)
        if (resultFile.includes('cloudinary.com') && resultFile.includes('/image/upload/') && resultFile.endsWith('.pdf')) {
          alert('PDF viewing is restricted on Cloudinary free accounts. Please contact the administrator to enable PDF delivery or upgrade the account.');
          console.warn('Cloudinary PDF delivery restriction detected:', resultFile);
          return;
        }
        
        console.log('Opening result file:', resultFile);
        window.open(resultFile, '_blank');
      } catch (error) {
        console.error('Invalid result file URL:', resultFile);
        alert('Invalid result file URL. Please contact support.');
      }
    }
    
    // View corporate staff result
    async function viewResult(organizationId, staffIndex) {
      console.log('Viewing corporate result:', { organizationId, staffIndex });
      
      try {
        const response = await fetch(`${API_ROOT}/corporate-bookings/${organizationId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          const org = result.data;
          
          if (org.staff_members && org.staff_members[staffIndex]) {
            const staff = org.staff_members[staffIndex];
            console.log('Staff member data:', staff);
            
            if (staff.result_file) {
              console.log('Opening corporate result file:', staff.result_file);
              
              // Check if it's a valid URL
              try {
                new URL(staff.result_file);
                
                // Check if it's a Cloudinary PDF with image/upload path (restricted)
                if (staff.result_file.includes('cloudinary.com') && staff.result_file.includes('/image/upload/') && staff.result_file.endsWith('.pdf')) {
                  alert('PDF viewing is restricted on Cloudinary free accounts. Please contact the administrator to enable PDF delivery or upgrade the account.');
                  console.warn('Cloudinary PDF delivery restriction detected:', staff.result_file);
                  return;
                }
                
                window.open(staff.result_file, '_blank');
              } catch (error) {
                console.error('Invalid result file URL:', staff.result_file);
                alert('Invalid result file URL. Please contact support.');
              }
            } else {
              alert('No result file available for this staff member');
            }
          } else {
            alert('Staff member not found');
          }
        } else {
          throw new Error('Failed to fetch corporate booking data');
        }
      } catch (error) {
        console.error('Error viewing result:', error);
        alert('Error loading result file');
      }
    }

    // Initialize
    $(document).ready(function() {
      loadIndividualAppointments();
      loadCorporateBookings();
    });
  </script>
</body>
</html>
